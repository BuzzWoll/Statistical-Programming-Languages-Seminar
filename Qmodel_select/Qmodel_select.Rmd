---
title: "Qmodel_select"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{R}
# Model selection
# Selects models based on the Bayesian Information Criterion (BIC), for each of the desired model specifications
library("xts")
load("../Qpca/diff_index.RData")
load("../Qpca/y.sample.RData")

# data frame that holds all possible model parameters
model_select = expand.grid(diff = c(0:5), q = c(1:8), p = c(0:8))

model_ = function(diff, q, p){
    # Fits model according to input specification
    # Input: Integer diff, the number of diffusion indexes to be used
    #        Integer q, the lag length of the diffusion index term
    #        Integer p, the lag length of the AR term
    # Output: Numeric bic, the BIC value of the model
  
    if(diff == 0 & p != 0 & q == 1){
        model = lm(y.sample ~ lag(y.sample, k=c(1:p)),
                na.action = na.omit)
    } else if(p == 0){
        model = lm(y.sample ~ lag(diff_index[,1:diff],k=c(1:q)),
                na.action = na.omit)
    } else if(diff == 0 & (p == 0 | q != 1)){
        return(NA)
    } else{
        model = lm(y.sample ~ lag(diff_index[,1:diff],k=c(1:q)) + 
                lag(y.sample, k=c(1:p)),
                na.action = na.omit)
    }
    bic = BIC(model)
    return(bic)
}

# Applies the model_ function on all possible parameter combinations stored in model_select
model_select$BIC = apply(model_select, 1, function(x) model_(x['diff'],x['q'],x['p']))

# selects the optimal DI model based on BIC
DI_models = model_select[model_select$p == 0 & model_select$diff > 0,]
DI_model_select = DI_models[which(DI_models$BIC == min(DI_models$BIC, na.rm = T)),]

# selects the optimal DI_AR model based on BIC
DI_AR_models = model_select[model_select$diff > 0 & model_select$p > 0,]
DI_AR_model_select = DI_AR_models[which(DI_AR_models$BIC == min(DI_AR_models$BIC, na.rm = T)),]

# selects the optimal AR model based on BIC
AR_models = model_select[model_select$diff == 0 & model_select$p > 0, ]
AR_model_select = AR_models[which(AR_models$BIC == min(AR_models$BIC, na.rm = T)),]

# stores all selected model specifications in data frame
model_sel = rbind(DI_model_select, DI_AR_model_select, AR_model_select)
row.names(model_sel) = c("DI_model", "DI_AR_model", "AR_model")

save(model_sel, file = "model_sel.RData")
```