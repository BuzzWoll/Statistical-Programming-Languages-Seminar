---
title: "Qmodel_select"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{R}
load("../Qpca/diff_index.RData")
load("../Qpca/x.sample.RData")
load("../Qpca/y.sample.RData")

# Model selection
# provides a data.frame to store the results of the model selection process

# stores the first five PCAs in an xts object
model_select = data.frame(t(c(0,0,0,0)))
names(model_select) = c("DF", "lags", "AR", "BIC")
#all_models = list(list(list()))
all_models = list()
for(i in 1:5){
    jlist = list()
  for(j in 1:8){
    llist = list()
    for(l in 1:9){
      diff_2 = ifelse(i > 1,1,0) * diff_index[,2] 
      diff_3 = ifelse(i > 2,1,0) * diff_index[,3] 
      diff_4 = ifelse(i > 3,1,0) * diff_index[,4] 
      diff_5 = ifelse(i > 4,1,0) * diff_index[,5]
      ar_y = ifelse(l < 2, 0, 1) * y.sample
     
      model = lm(y.sample ~ lag(diff_index[,1],k=c(1:j)) + 
                            lag(ar_y, k=c(1:(l-1))) +
                            lag(diff_2,k=c(1:j)) +
                            lag(diff_3,k=c(1:j)) +
                            lag(diff_4,k=c(1:j)) +
                            lag(diff_5,k=c(1:j)), 
                            na.action = na.omit)

      bic = BIC(model)
      # append this to dataframe
      model_select = rbind(model_select, c(i,j,(l-1), round(bic,2)))
      llist[l] = model
    }
    jlist[j] = list(llist)
  }
  all_models[i] = list(jlist)
}
# print the full line of the optimal DI model
DI_model_select = model_select[which(model_select$BIC == min(model_select[model_select$AR == 0 & model_select$DF > 0,"BIC"])),]

# print the full line of the optimal DI-AR model
DI_AR_model_select = model_select[which(model_select$BIC == min(model_select[model_select$AR > 0,"BIC"])),]

# AR model selection

AR_model = function(p,y){
  model = lm(y ~ lag(y, k = c(1:p)))
  bic = BIC(model)
  return(c(p, bic))
}

AR_model_select = sapply(1:8, AR_model, y = y.sample)
AR_model_select = c(0,0, AR_model_select[,which(min(AR_model_select[2,]) == AR_model_select[2,])])


model_sel = rbind(DI_model_select, DI_AR_model_select, AR_model_select) 
row.names(model_sel) = c("DI_model", "DI_AR_model", "AR_model")
model_sel

save(model_sel, file = "model_sel.RData")

all_models[[1]][[4]][[1]]
```