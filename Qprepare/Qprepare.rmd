---
title: "Qprepare"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2)

load("../Qload/data.RData")
#check for NA values
any(is.na(train))

#compare some data 
ggplot(data=train,
       aes(x=date))  + geom_smooth(aes(y = `S&P500`), colour="blue",span=0.1) + geom_smooth(aes(y = GDAXI), colour = "red", span=0.1) + geom_smooth(aes(y = IPMAN), colour = "cyan", span=0.1)

#check for outliers visually
boxplot(train[,-1])

#since this is macroeconomic data and all outliers are explainable by events or legislations (which can be treated as events as well)
#data will be centered and scaled so no variable will have a bigger impact than another
```

```{r}
#Dickey Fuller Test
library(urca)

dickey = function(x){
  df = ur.df(train[,x],type="none",lags=1)
  df@teststat[1,1] < df@cval[1,1]
  
}

seriesDetails$dickeyres = sapply(colnames(train[,-1]),dickey)
seriesDetails
```

```{r}
library(dplyr)
library(data.table)

#Define which preprocessing step should be done for the time series
#This is based on the appendix of the paper and on the authors choices of what to apply

seriesDetails$preparation = case_when(
  seriesDetails$units %in% c("3-Month Annualized Percent Change","Percent","Percent Change at Annual Rate","Percent of Capacity" ) ~ "Nothing",
  grepl("Nonsupervisory Employees: Manufacturing",seriesDetails$title) ~ "Nothing",
  grepl("Trade Balance", seriesDetails$title) ~ "First Difference",
  grepl("Consumer Price",seriesDetails$title) ~ "Second Difference of Logarithm",
  grepl("Hourly Earnings", seriesDetails$title) ~ "Second Difference of Logarithm",
  grepl("Index",seriesDetails$units) ~ "First Difference of Logarithm",
  grepl("Thousands",seriesDetails$units) ~"First Difference of Logarithm",
  seriesDetails$units %in% "Millions of Dollars" ~ "First Difference of Logarithm",
  grepl("Personal Consumption",seriesDetails$title) ~ "First Difference of Logarithm",
  TRUE ~ "Second Difference of Logarithm"
)

dt = as.data.table(seriesDetails)
setindex(dt, "id")




firstDifferenceLog = function(x){
  tmp = diff(log(x), lag = 1)
  tmp[-1]
}

secondDifferenceLog = function(x){
  tmp = diff(log(x), lag = 1, differences = 2)
  tmp
}




prepare = function(data,lookup){
  tmp = data[,-1]
  
  res = sapply(colnames(tmp), function (x) if(lookup[id %in% x]$preparation == "First Difference of Logarithm"){
    firstDifferenceLog(tmp[,x])
  }else{
    if(lookup[id %in% x]$preparation == "Second Difference of Logarithm"){
      secondDifferenceLog(tmp[,x])
    }else{
      if(lookup[id %in% x]$preparation == "First Difference"){
        diff(tmp[,x],lag=1)[-1]
      }else{
        tmp[,x][-c(1,2)]
      }
      
    }
  })
  data=data[-c(1,2),]
  data[,-1] = res
  data
}

trainprepared = prepare(train,dt)

#check if there is any time series that fails the dickey fuller test
any(sapply(colnames(trainprepared[,-1]),dickey)==TRUE)

trainprepared

ggplot(data=trainprepared,
       aes(x=date))  + geom_smooth(aes(y = `S&P500`), colour="blue",span=0.1) + geom_smooth(aes(y = GDAXI), colour = "red", span=0.1) + geom_smooth(aes(y = IPMAN), colour = "cyan", span=0.1)

```

```{r}
#center and scale
unscaled_train = trainprepared
scaledtrain = scale(trainprepared[,-1])
trainprepared[,-1] = scaledtrain
scaledtrain = trainprepared
save(scaledtrain, file="prepareddataSC.RData")
save(unscaled_train, file = "prepareddata.RData")

ggplot(data=scaledtrain,
       aes(x=date))  + geom_smooth(aes(y = `S&P500`), colour="blue",span=0.1) + geom_smooth(aes(y = GDAXI), colour = "red", span=0.1) + geom_smooth(aes(y = BOPGSTB), colour = "cyan", span=0.1)

```

